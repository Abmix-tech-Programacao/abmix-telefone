Oi Felipe! üëã Bora direto ao ponto. Pelos logs e pelo c√≥digo do repo abmix-telefone, d√° pra ver dois problemas distintos causando o ‚ÄúSIP not registered‚Äù.

O que os logs e o c√≥digo mostram

O erro raiz √©: ‚Äúsip.send is not a function‚Äù durante o registro (REGISTER), o que impede a conta de ficar registrada e, por consequ√™ncia, o discador falha com ‚ÄúSIP not registered‚Äù (veja o log com o stack e o ponto do c√≥digo) 

Pasted--FALEVONO-PROVIDER-Faile‚Ä¶

, 

sipService

.

Em uma execu√ß√£o voc√™ registrou como Username: Fe120784! (isso tem cara de senha sendo usada como usu√°rio), noutra como Felipe_Manieri (correto). Ou seja, houve tentativa com credencial trocada (veja o username nos logs) 

Pasted--FALEVONO-PROVIDER-Faile‚Ä¶

.

No c√≥digo:

Voc√™ usa o pacote sip do Node e chama sip.start(...) e depois sip.send(...) para mandar o REGISTER/INVITE (pontos exatos) 

sipService

, 

sipService

, 

sipService

, 

sipService

.

Voc√™ at√© loga os tipos de sip.start e sip.send, e lan√ßa erro se sip.send n√£o for fun√ß√£o (onde explode) 

sipService

, 

sipService

.

Causas prov√°veis

Import/interop do m√≥dulo sip
Em runtime, require('sip') deve expor start, send, stop. Se send vem como undefined, √© t√≠pico de:

Ambiente ESM + bundling/transpile alterando o objeto exportado do sip; ou

Alguma reatribui√ß√£o do s√≠mbolo sip (n√£o vi outra reatribui√ß√£o no arquivo); ou

Vers√£o/instala√ß√£o do pacote sip inconsistente no ambiente que roda o dist.

Credenciais trocadas (username ‚â† password)
Em uma tentativa, o ‚Äúusername‚Äù logado √© ‚ÄúFe120784!‚Äù (parece senha). Isso garante falha de registro mesmo que sip.send estivesse ok (o servidor vai desafiar 401/407 e nunca completar) 

Pasted--FALEVONO-PROVIDER-Faile‚Ä¶

.

Corre√ß√µes recomendadas (em ordem pr√°tica)

Ajuste do import do m√≥dulo sip (ESM-safe)
No server/sipService.ts, troque para um import que n√£o dependa de hooches do bundler:

// antes
const sip = require('sip');

// depois (duas op√ß√µes est√°veis; escolha UMA)
// Op√ß√£o A: manter CommonJS, mas congele a refer√™ncia que voc√™ usa
const sipModule = require('sip'); // CJS
const sip = sipModule; // alias expl√≠cito para evitar sombreamento

// Op√ß√£o B (preferida em ESM puro):
import sipModule from 'sip';            // se o pacote suportar default
const sip: any = (sipModule as any).default ?? sipModule;


E mantenha os usos como sip.start(...); sip.send(...); sip.stop();.
O ponto onde voc√™ hoje valida e lan√ßa o erro fica igual (s√≥ que agora o objeto certo chega) 

sipService

.

Dica de diagn√≥stico r√°pido: adicione temporariamente:

console.log('[SIP path]', require.resolve('sip'));
console.log('[SIP keys]', Object.keys(sip));


Se send n√£o aparecer, √© import mesmo.

N√£o fa√ßa ‚Äúdelay m√°gico‚Äù para o sip.send ‚Äúaparecer‚Äù
O send deve existir imediatamente ap√≥s o import. O delay de 2s n√£o deveria ser necess√°rio; se send est√° undefined antes e depois, √© import/interop. Voc√™ pode manter o guard (bom pra sanity check), mas a solu√ß√£o √© o import correto (onde hoje explode) 

sipService

.

Confirme as credenciais usadas

O provider busca a senha do process.env.FALEVONO_PASSWORD (obrigat√≥rio) e o username do registro em banco (voip number) 

faleVonoProvider

, 

providerFactory

.

Garanta que no banco sip_username √© algo como Felipe_Manieri (ou o usu√°rio SIP correto) e n√£o a senha. No log em que falhou aparecia ‚ÄúFe120784!‚Äù como username (suspeito) 

Pasted--FALEVONO-PROVIDER-Faile‚Ä¶

.

Se o FALEVONO_PASSWORD n√£o estiver setado, o provider quebra na cria√ß√£o (ele valida isso) 

faleVonoProvider

, 

providerFactory

.

Verifique a porta local de cliente (FALEVONO_SIP_PORT)

Voc√™ usa UDP e porta padr√£o 6060 (override por env). Se a porta estiver bloqueada no host, o start pode at√© subir mas n√£o trafegar. N√£o explica send undefined, mas pode travar chamadas depois. O c√≥digo pega a porta do env e loga isso (bom checar) 

sipService

.

Registro (REGISTER) e fluxo de chamada
A rotina de REGISTER est√° correta (com digest quando 401/407). Assim que sip.send estiver ok e as credenciais corretas, a Promise de registro resolve e a chamada segue com INVITE (veja onde a Promise √© criada/esperada) 

sipService

, 

sipService

.

Patch m√≠nimo sugerido (trecho)

No sipService.ts, ajuste o import e remova a depend√™ncia do ‚Äúdelay‚Äù como requisito:

// topo do arquivo
import { createRequire } from 'module';
const require = createRequire(import.meta.url);
const sipModule = require('sip');
const sip: any = (sipModule as any).default ?? sipModule;

// dentro de initialize()
sip.start({ /* ...como est√°... */ }, (request: any) => {
  this.handleIncomingRequest(request);
});

// Voc√™ pode manter o guard, mas se ele falhar, √© import/env:
if (typeof sip.send !== 'function') {
  console.error('[SIP_SERVICE] ‚ùå sip.send ausente. Keys:', Object.keys(sip));
  throw new Error('SIP stack n√£o inicializou corretamente - send ausente');
}


E, no banco/console administrativo do app, confirme e corrija:

sip_username = "Felipe_Manieri" (ou o username SIP real)

FALEVONO_PASSWORD setado no ambiente do processo (n√£o no banco) 

faleVonoProvider

.

Resumo

Erro imediato: import/interop do pacote sip ‚Äî send fica undefined e o REGISTER n√£o sai.

Erro secund√°rio: em uma tentativa, o username pareceu ser a senha, o que impediria o registro mesmo com send correto.

A√ß√£o: corrigir import do sip, garantir env FALEVONO_PASSWORD, e conferir sip_username no registro do n√∫mero. Depois disso, o fluxo REGISTER ‚Üí 200 ‚Üí INVITE deve rodar normalmente (o seu handler de respostas/ACK/DTMF est√° bem estruturado) 

sipService

, 

sipService

, 

sipService

.

Se quiser, eu j√° te mando um patch completo no sipService.ts com os ajustes de import e logs de diagn√≥stico ‚Äî √© s√≥ falar o formato que prefere (diff/PR).